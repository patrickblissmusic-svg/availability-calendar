<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Availability Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 10px; }
    h2 { margin: 10px 0; }
    .calendar-controls { margin-bottom: 10px; display: flex; gap: 8px; align-items: center; }
    button { padding: 6px 10px; }
    select { padding: 6px 10px; }
    /* Force a 7-column grid */
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .day { border: 1px solid #ccc; padding: 10px; text-align: center; min-height: 60px; cursor: pointer; position: relative; }
    .available { background-color: #c8f7c5; }
    .busy { background-color: #f7c5c5; cursor: default; }
    .byrequest { background-color: #eee; color: #555; }
    .weekday-header { font-weight: bold; background: #ddd; cursor: default; }
    .today { border: 2px solid #000; }
    .day:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: #333; color: #fff; padding: 3px 6px; font-size: 12px; white-space: nowrap; border-radius: 3px;
    }
    .legend { margin-top: 20px; display: flex; gap: 20px; flex-wrap: wrap; }
    .legend-box { display: inline-block; width: 20px; height: 20px; vertical-align: middle; margin-right: 5px; border: 1px solid #ccc; }
    @media (max-width: 600px) {
      .day { padding: 5px; min-height: 40px; }
    }
  </style>
</head>
<body>
  <h1>Pick your date and let’s make music happen!</h1>
  <div class="calendar-controls">
    <button id="prev">Previous</button>
    <select id="month-select"></select>
    <button id="next">Next</button>
  </div>
  <h2 id="month-title"></h2>
  <div id="calendar"></div>

  <div class="legend">
    <div><span class="legend-box available"></span> Available</div>
    <div><span class="legend-box busy"></span> Busy</div>
    <div><span class="legend-box byrequest"></span> By Request</div>
  </div>

  <script>
    // Your credentials
    const calendarId = "patrickblissmusic@gmail.com";
    const apiKey = "AIzaSyAZzcXiSs2108Z8W64J94D2b2eMqrLSNuQ";
    const bookingEmail = "booking@patrickblissmusic.com";

    let busyDates = new Set();
    const today = new Date();
    const endDate = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());
    let months = [];
    let currentMonthIndex = 0;

    async function loadCalendarData() {
      try {
        // Fetch events (public calendar, free/busy works)
        const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?key=${apiKey}&showDeleted=false&singleEvents=true&orderBy=startTime&timeMin=${new Date().toISOString()}`;
        const response = await fetch(url);
        const data = await response.json();

        // Build a set of busy dates, handling all-day and timed events
        busyDates = new Set();
        for (const ev of (data.items || [])) {
          const start = ev.start?.date || ev.start?.dateTime;
          const end = ev.end?.date || ev.end?.dateTime;

          if (!start || !end) continue;

          const startDate = new Date(start);
          const endDateObj = new Date(end);

          // Iterate day-by-day from start to end-1 (Google all-day end is exclusive)
          const d = new Date(startDate);
          while (d < endDateObj) {
            busyDates.add(d.toISOString().split("T")[0]);
            d.setDate(d.getDate() + 1);
          }
        }

        // Build month list (12 months ahead)
        months = [];
        let current = new Date(today.getFullYear(), today.getMonth(), 1);
        while (current <= endDate) {
          months.push(new Date(current));
          current.setMonth(current.getMonth() + 1);
        }

        // Populate dropdown
        const monthSelect = document.getElementById("month-select");
        monthSelect.innerHTML = "";
        months.forEach((m, i) => {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = m.toLocaleDateString("en-US", { month: "long", year: "numeric" });
          monthSelect.appendChild(option);
        });
        monthSelect.addEventListener("change", e => {
          currentMonthIndex = parseInt(e.target.value, 10);
          renderMonth(currentMonthIndex);
        });

        renderMonth(currentMonthIndex);
      } catch (err) {
        console.error("Error loading calendar:", err);
        document.getElementById("calendar").innerHTML = "<p>Could not load calendar data.</p>";
      }
    }

    function renderMonth(index) {
      const monthStart = months[index];
      document.getElementById("month-title").textContent =
        monthStart.toLocaleDateString("en-US", { month: "long", year: "numeric" });
      document.getElementById("month-select").value = index;

      const calendarDiv = document.getElementById("calendar");
      calendarDiv.innerHTML = "";

      // Weekday headers
      ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d => {
        const h = document.createElement("div");
        h.textContent = d;
        h.classList.add("day","weekday-header");
        calendarDiv.appendChild(h);
      });

      const firstDay = new Date(monthStart.getFullYear(), monthStart.getMonth(), 1);
      const lastDay = new Date(monthStart.getFullYear(), monthStart.getMonth()+1, 0);

      // Empty cells before first day
      for (let i=0; i<firstDay.getDay(); i++) {
        const empty = document.createElement("div");
        empty.classList.add("day");
        calendarDiv.appendChild(empty);
      }

      // Day cells
      for (let d=1; d<=lastDay.getDate(); d++) {
        const dateObj = new Date(monthStart.getFullYear(), monthStart.getMonth(), d);
        const iso = dateObj.toISOString().split("T")[0];
        const dayDiv = document.createElement("div");
        dayDiv.classList.add("day");
        dayDiv.textContent = d;

        const dow = dateObj.getDay(); // 0=Sun .. 6=Sat
        if ([4,5,6,0].includes(dow)) { // Thu–Sun
          if (busyDates.has(iso)) {
            dayDiv.classList.add("busy");
            dayDiv.dataset.tooltip = "Unavailable";
          } else {
            dayDiv.classList.add("available");
            dayDiv.dataset.tooltip = "Click to book";
            dayDiv.addEventListener("click", () => {
              const subject = encodeURIComponent(`Booking Request: ${dateObj.toDateString()}`);
              const body = encodeURIComponent(
                `Hello Patrick,\n\nI’d like to book you for ${dateObj.toDateString()}.\n\nEvent Details:\n- Location:\n- Time:\n- Type of Event:\n\nThanks!`
              );
              window.location.href = `mailto:${bookingEmail}?subject=${subject}&body=${body}`;
            });
          }
        } else {
          dayDiv.classList.add("byrequest");
          dayDiv.dataset.tooltip = "Click to request booking";
          dayDiv.addEventListener("click", () => {
            const subject = encodeURIComponent(`Booking Request (By Request): ${dateObj.toDateString()}`);
            const body = encodeURIComponent(
              `Hello Patrick,\n\nI’d like to book you for ${dateObj.toDateString()} (By Request).\n\nEvent Details:\n- Location:\n- Time:\n- Type of Event:\n\nThanks!`
            );
            window.location.href = `mailto:${bookingEmail}?subject=${subject}&body=${body}`;
          });
        }

        // Highlight today
        if (dateObj.toDateString() === today.toDateString()) {
          dayDiv.classList.add("today");
        }

        calendarDiv.appendChild(dayDiv);
      }
    }

    document.getElementById("prev").addEventListener("click", () => {
      if (currentMonthIndex > 0) {
        currentMonthIndex--;
        renderMonth(currentMonthIndex);
      }
    });

    document.getElementById("next").addEventListener("click", () => {
      if (currentMonthIndex < months.length-1) {
        currentMonthIndex++;
        renderMonth(currentMonthIndex);
      }
    });

    loadCalendarData();
  </script>
</body>
</html>
