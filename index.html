<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Availability Calendar</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin: 10px 0; }
    .calendar-controls { margin-bottom: 10px; }
    button { margin: 0 5px; padding: 5px 10px; }
    .month { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .day { border: 1px solid #ccc; padding: 10px; text-align: center; min-height: 60px; cursor: pointer; position: relative; }
    .available { background-color: #c8f7c5; } /* green = available */
    .busy { background-color: #f7c5c5; cursor: default; } /* red = busy */
    .byrequest { background-color: #eee; color: #555; } /* grey = by request */
    .weekday-header { font-weight: bold; background: #ddd; cursor: default; }
    .legend { margin-top: 20px; }
    .legend-item { display: inline-block; margin-right: 20px; }
    .legend-box { display: inline-block; width: 20px; height: 20px; vertical-align: middle; margin-right: 5px; border: 1px solid #ccc; }
    .today { border: 2px solid #000; } /* highlight today */
    .day:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 3px 6px;
      font-size: 12px;
      white-space: nowrap;
      border-radius: 3px;
    }
    @media (max-width: 600px) {
      .month { grid-template-columns: repeat(7, 1fr); font-size: 12px; }
      .day { padding: 5px; min-height: 40px; }
    }
  </style>
</head>
<body>
  <h1>Pick your date and let’s make music happen!</h1>
  <div class="calendar-controls">
    <button id="prev">Previous</button>
    <select id="month-select"></select>
    <button id="next">Next</button>
  </div>
  <h2 id="month-title"></h2>
  <div id="calendar"></div>

  <!-- Legend -->
  <div class="legend">
    <div class="legend-item"><span class="legend-box available"></span> Available</div>
    <div class="legend-item"><span class="legend-box busy"></span> Busy</div>
    <div class="legend-item"><span class="legend-box byrequest"></span> By Request</div>
  </div>

  <!-- Load ical.js -->
  <script src="https://cdn.jsdelivr.net/npm/ical.js@latest/build/ical.min.js"></script>
  <script>
    const icalUrl = "https://calendar.google.com/calendar/ical/patrickblissmusic%40gmail.com/public/basic.ics";
    const bookingEmail = "booking@patrickblissmusic.com";

    let busyDates = new Set();
    let today = new Date();
    let endDate = new Date(today);
    endDate.setDate(today.getDate() + 365);

    let months = []; // store month start dates
    let currentMonthIndex = 0;

    async function loadCalendarData() {
      const response = await fetch(icalUrl);
      const text = await response.text();
      const jcalData = ICAL.parse(text);
      const comp = new ICAL.Component(jcalData);
      const events = comp.getAllSubcomponents("vevent");

      busyDates = new Set(events.map(ev => {
        const e = new ICAL.Event(ev);
        return e.startDate.toJSDate().toISOString().split("T")[0];
      }));

      // Build list of months
      let current = new Date(today.getFullYear(), today.getMonth(), 1);
      while (current <= endDate) {
        months.push(new Date(current));
        current.setMonth(current.getMonth() + 1);
      }

      // Populate dropdown
      const monthSelect = document.getElementById("month-select");
      months.forEach((m, i) => {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = m.toLocaleDateString("en-US", { month: "long", year: "numeric" });
        monthSelect.appendChild(option);
      });
      monthSelect.addEventListener("change", e => {
        currentMonthIndex = parseInt(e.target.value);
        renderMonth(currentMonthIndex);
      });

      renderMonth(currentMonthIndex);
    }

    function renderMonth(index) {
      const monthStart = months[index];
      const monthName = monthStart.toLocaleDateString("en-US", { month: "long", year: "numeric" });
      document.getElementById("month-title").textContent = monthName;
      document.getElementById("month-select").value = index;

      const calendarDiv = document.getElementById("calendar");
      calendarDiv.innerHTML = "";

      // Weekday headers
      ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d => {
        const h = document.createElement("div");
        h.textContent = d;
        h.classList.add("day","weekday-header");
        calendarDiv.appendChild(h);
      });

      const firstDay = new Date(monthStart.getFullYear(), monthStart.getMonth(), 1);
      const lastDay = new Date(monthStart.getFullYear(), monthStart.getMonth()+1, 0);

      // Empty slots before first day
      for (let i=0; i<firstDay.getDay(); i++) {
        const empty = document.createElement("div");
        empty.classList.add("day");
        calendarDiv.appendChild(empty);
      }

      // Fill days
      for (let d=1; d<=lastDay.getDate(); d++) {
        const dateObj = new Date(monthStart.getFullYear(), monthStart.getMonth(), d);
        const iso = dateObj.toISOString().split("T")[0];
        const dayDiv = document.createElement("div");
        dayDiv.classList.add("day");
        dayDiv.textContent = d;

        const dow = dateObj.getDay(); // 0=Sun, 1=Mon...
        if ([4,5,6,0].includes(dow)) { // Thu–Sun
          if (busyDates.has(iso)) {
            dayDiv.classList.add("busy");
            dayDiv.dataset.tooltip = "Unavailable";
          } else {
            dayDiv.classList.add("available");
            dayDiv.dataset.tooltip = "Click to book";
            dayDiv.addEventListener("click", () => {
              const subject = encodeURIComponent(`Booking Request: ${dateObj.toDateString()}`);
              const body = encodeURIComponent(
                `Hello Patrick,\n\nI’d like to book you for ${dateObj.toDateString()}.\n\nEvent Details:\n- Location:\n- Time:\n- Type of Event:\n\nThanks!`
              );
              window.location.href = `mailto:${bookingEmail}?subject=${subject}&body=${body}`;
            });
          }
        } else {
          dayDiv.classList.add("byrequest");
          dayDiv.dataset.tooltip = "Click to request booking";
          dayDiv.addEventListener("click", () => {
            const subject = encodeURIComponent(`Booking Request (By Request): ${dateObj.toDateString()}`);
            const body = encodeURIComponent(
              `Hello Patrick,\n\nI’d like to book you for ${dateObj.toDateString()} (By Request).\n\nEvent Details:\n- Location:\n- Time:\n- Type of Event:\n\nThanks!`
            );
            window.location.href = `mailto:${bookingEmail}?subject=${subject}&body=${body}`;
          });
        }

        // Highlight today
        if (dateObj.toDateString() === today.toDateString()) {
          dayDiv.classList.add("today");
        }

        calendarDiv.appendChild(dayDiv);
      }
    }

    document.getElementById("prev").addEventListener("click", () => {
      if (currentMonthIndex > 0) {
        currentMonthIndex--;
        renderMonth(currentMonthIndex);
      }
    });

    document.getElementById("next").addEventListener("click", () => {
      if (currentMonthIndex < months.length-1) {
        currentMonthIndex++;
        renderMonth(currentMonthIndex);
      }
    });

    loadCalendarData();
  </script>
</body>
</html>
