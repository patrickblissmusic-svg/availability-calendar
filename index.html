<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Availability Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: url('https://images.squarespace-cdn.com/content/v1/659d61b9993b4640fe5eb493/73eae0ff-9759-4b9b-a8c8-0b08b11aaccf/IMG_6055.JPEG') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
    }
    h1, h2 { text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }
    .calendar-controls { margin-bottom: 10px; display: flex; gap: 8px; align-items: center; }
    button, select { padding: 6px 10px; border-radius: 4px; border: none; }
    #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .day {
      border: 1px solid rgba(255,255,255,0.4);
      padding: 6px;
      text-align: center;
      min-height: 80px;
      cursor: pointer;
      position: relative;
      background-color: rgba(0,0,0,0.4);
      color: #fff;
      border-radius: 12px;
      transition: transform 0.2s, background-color 0.2s;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      font-size: 12px;
    }
    .day:hover { transform: scale(1.05); background-color: rgba(255,255,255,0.25); }
    .available { background-color: rgba(0, 255, 0, 0.3); }
    .busy { background-color: rgba(255, 0, 0, 0.3); cursor: default; }
    .byrequest { background-color: rgba(128, 128, 128, 0.3); color: #ddd; }
    .weekday-header { font-weight: bold; background: rgba(255,255,255,0.2); border-radius: 8px; }
    .today { border: 2px solid #fff; }
    .event-info { margin-top: 4px; font-size: 11px; text-align: center; }
    .legend { margin-top: 20px; display: flex; gap: 20px; flex-wrap: wrap; }
    .legend-box { width: 20px; height: 20px; display: inline-block; margin-right: 5px; border: 1px solid #ccc; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Pick your date and let’s make music happen!</h1>
  <div class="calendar-controls">
    <button id="prev">Previous</button>
    <select id="month-select"></select>
    <button id="next">Next</button>
  </div>
  <h2 id="month-title"></h2>
  <div id="calendar"></div>

  <div class="legend">
    <div><span class="legend-box available"></span> Available</div>
    <div><span class="legend-box busy"></span> Busy</div>
    <div><span class="legend-box byrequest"></span> By Request</div>
  </div>

  <script>
    const calendarId = "patrickblissmusic@gmail.com";
    const apiKey = "AIzaSyAZzcXiSs2108Z8W64J94D2b2eMqrLSNuQ";
    const bookingEmail = "booking@patrickblissmusic.com";

    let busyDates = new Map();
    const today = new Date();
    const endDate = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());
    let months = [];
    let currentMonthIndex = 0;

    async function loadCalendarData() {
      try {
        const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?key=${apiKey}&showDeleted=false&singleEvents=true&orderBy=startTime&timeMin=${new Date().toISOString()}`;
        const response = await fetch(url);
        const data = await response.json();

        busyDates = new Map();
        for (const ev of (data.items || [])) {
          const start = ev.start?.date || ev.start?.dateTime;
          const end = ev.end?.date || ev.end?.dateTime;
          if (!start || !end) continue;

          const startDate = new Date(start);
          const endDateObj = new Date(end);
          const d = new Date(startDate);
          while (d < endDateObj) {
            const iso = d.toISOString().split("T")[0];
            const details = `${ev.summary || "Busy"}${ev.location ? " @ " + ev.location : ""}`;
            busyDates.set(iso, details);
            d.setDate(d.getDate() + 1);
          }
        }

        months = [];
        let current = new Date(today.getFullYear(), today.getMonth(), 1);
        while (current <= endDate) {
          months.push(new Date(current));
          current.setMonth(current.getMonth() + 1);
        }

        const monthSelect = document.getElementById("month-select");
        monthSelect.innerHTML = "";
        months.forEach((m, i) => {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = m.toLocaleDateString("en-US", { month: "long", year: "numeric" });
          monthSelect.appendChild(option);
        });
        monthSelect.addEventListener("change", e => {
          currentMonthIndex = parseInt(e.target.value, 10);
          renderMonth(currentMonthIndex);
        });

        renderMonth(currentMonthIndex);
      } catch (err) {
        console.error("Error loading calendar:", err);
        document.getElementById("calendar").innerHTML = "<p>Could not load calendar data.</p>";
      }
    }

    function renderMonth(index) {
      const monthStart = months[index];
      document.getElementById("month-title").textContent =
        monthStart.toLocaleDateString("en-US", { month: "long", year: "numeric" });
      document.getElementById("month-select").value = index;

      const calendarDiv = document.getElementById("calendar");
      calendarDiv.innerHTML = "";

      ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d => {
        const h = document.createElement("div");
        h.textContent = d;
        h.classList.add("day","weekday-header");
        calendarDiv.appendChild(h);
      });

      const firstDay = new Date(monthStart.getFullYear(), monthStart.getMonth(), 1);
      const lastDay = new Date(monthStart.getFullYear(), monthStart.getMonth()+1, 0);

      for (let i=0; i<firstDay.getDay(); i++) {
        const empty = document.createElement("div");
        empty.classList.add("day");
        calendarDiv.appendChild(empty);
      }

      for (let d=1; d<=lastDay.getDate(); d++) {
        const dateObj = new Date(monthStart.getFullYear(), monthStart.getMonth(), d);
        const iso = dateObj.toISOString().split("T")[0];
        const dayDiv = document.createElement("div");
        dayDiv.classList.add("day");

        const dateLabel = document.createElement("div");
        dateLabel.textContent = d;
        dateLabel.style.fontWeight = "bold";
        dayDiv.appendChild(dateLabel);

        const dow = dateObj.getDay();
        if ([4,5,6,0].includes(dow)) {
          if (busyDates.has(iso)) {
            dayDiv.classList.add("busy");
            const info = document.createElement("div");
            info.classList.add("event-info");
            info.textContent = busyDates.get(iso);
            dayDiv.appendChild(info);
          } else {
            dayDiv.classList.add("available");
            const info = document.createElement("div");
            info.classList.add("event-info");
            info.textContent = "Available";
            dayDiv.appendChild(info);
            dayDiv.addEventListener("click", () => {
              const subject = encodeURIComponent(`Booking Request: ${dateObj.toDateString()}`);
              const body = encodeURIComponent(
                `Hello Patrick,\n\nI’d like to book you for ${dateObj.toDateString()}.\n\nEvent Details:\n- Location:\n- Time:\n- Type of Event:\n\nThanks!`
              );
              window.location.href = `mailto:${bookingEmail}?subject=${subject}&body=${body}`;
          });
        }

        if (dateObj.toDateString() === today.toDateString()) {
          dayDiv.classList.add("today");
        }

        calendarDiv.appendChild(dayDiv);
      }
    }

    // Prev/Next controls
    document.getElementById("prev").addEventListener("click", () => {
      if (currentMonthIndex > 0) {
        currentMonthIndex--;
        renderMonth(currentMonthIndex);
      }
    });

    document.getElementById("next").addEventListener("click", () => {
      if (currentMonthIndex < months.length - 1) {
        currentMonthIndex++;
        renderMonth(currentMonthIndex);
      }
    });

    // Initial load
    loadCalendarData();
  </script>
</body>
</html>
